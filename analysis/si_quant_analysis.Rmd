---
title: "SI_quant"
output: html_document
---
Horowitz, Mekler, Schneider, Frank, etc. 
Analyses for Scalar Implicature, Give-Quantifier, and DCCS
---

Set up Rmd parameters
```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, message=FALSE, warning=FALSE)
```

Preliminaries
```{r}
rm(list=ls())
library(ggplot2)
library(reshape)
library(entropy)
library(pscl)
library(dplyr)
library(stringr)
library(tidyr)
library(markdown)
library(directlabels)
library(magrittr)
library(bootstrap)
library(RMySQL)
library(RCurl)


theme_set(theme_bw())
```


SI graphs and visualizations


```{r}
#reading in the original wide-form dataframe
d1 <- read.csv("../data/SI_coding.csv")


d2=melt.data.frame(d1,c("sub_ID","test_age","condition", "order", "training"),c("carrot", "hat", "cookies", "trains", "cats", "purses",  "keys", "shirts", "breads", "horses", "bears", "frogs", "plates", "books", "elephants", "lamps", "bananas", "butterflies", "carrot_condition", "hat_condition", "cookies_condition", "trains_condition", "cats_condition", "purses_condition",  "keys_condition", "shirts_condition", "breads_condition", "horses_condition", "bears_condition", "frogs_condition", "plates_condition", "books_condition", "elephants_condition", "lamps_condition", "bananas_condition", "butterflies_condition", "carrot_type", "hat_type", "cookies_type", "trains_type", "cats_type", "purses_type",  "keys_type", "shirts_type", "breads_type", "horses_type", "bears_type", "frogs_type", "plates_type", "books_type", "elephants_type", "lamps_type", "bananas_type", "butterflies_type"))


#making a respectable df  
#data <- d2[1:576,] 
#data$condition <- d2$value[577:1152]
#data$type <- d2$value[1153:1728]
onethird <- (1/3)*nrow(d2)
data <- d2[1:onethird,]
data$condition <- d2$value[(onethird+1):(onethird*2)]
data$type <- d2$value[(2*onethird+1):nrow(d2)]
names(data)[6] <- "item"
names(data)[7] <- "SI_correct"
data$correct <- data$SI_correct==1

#filtering out NAs, adding agesplit
data %<>%
  filter(sub_ID != "", correct != "NA") %>%
  mutate(agesplit = cut(test_age, breaks=c(3, 3.5, 4, 4.5, 5)))%>%
  mutate(split_2 = cut(test_age, breaks = c(3, 4, 5)))%>%
  filter(agesplit != "NA")


data_si <- data
data_si$test <- "Scalar Implicature"
```



SI graphs
```{r}
# #number of kids in each age group
# num_kids <- data %>%
#   select(sub_ID, agesplit) %>%
#   distinct() %>%
#   group_by(agesplit)%>%
#   summarize(n=n())


#accuracy by age group in different trials 
agg.data <- aggregate(data$correct, list(data$type, data$agesplit), FUN=sum)
agg.data.len <- aggregate(data$correct, list(data$type, data$agesplit), FUN=length)
agg.data$x <- agg.data$x 
agg.data.len$x <- agg.data.len$x 

names(agg.data) <- c("type", "agesplit", "correct")
agg.data$total <- agg.data.len$x
agg.data$prop.corr <- agg.data$correct / agg.data$total

#prop correct and standard error
agg.data$q <- 1 - agg.data$prop.corr
agg.data$err <- sqrt((agg.data$prop.corr * agg.data$q) / agg.data$total)

#defining variables
dodge <- position_dodge(width=0.9) 
limits <- aes(ymax = prop.corr + err, ymin=prop.corr - err) 

#plot
quartz()
ggplot(data = agg.data, 
       aes(x=type, y=prop.corr, fill=agesplit)) +
  geom_bar(stat="identity", position = position_dodge())  + geom_errorbar(limits, position=dodge)+
  ylab("Proportion correct") + 
  xlab("Trial Type") +
  scale_fill_brewer(palette="Set1")
```


GQ analyses 


```{r}
#read in and establish dataframe
d1 <- read.csv("../data/GQ_coding.csv")
d1[,c(8,10,12,14,16,18,20,22)] <- sapply(d1[,c(8,10,12,14,16,18,20,22)],as.character) #for unknown reasons this is necessary for melt.data.frame now


#change to long form
d2=melt.data.frame(d1,c("sub_ID", "test_age","condition", "order", "training"),c("X1_condition", "X2_condition", "X3_condition", "X4_condition", "X5_condition", "X6_condition",  "X7_condition", "X8_condition", "X1_given", "X2_given", "X3_given", "X4_given", "X5_given", "X6_given",  "X7_given", "X8_given"))

#making a respectable df  
#data <- d2[1:256,] 
#data$num_given <- d2$value[257:512]
firsthalf <- nrow(d2)/2
data <- d2[1:firsthalf,]
data$num_given <- d2$value[(firsthalf+1):nrow(d2)]
names(data)[6] <- "trial"
names(data)[7] <- "prompt"


#filtering data, creating age breaks
data %<>%
  filter(sub_ID != "", num_given != "N/A") %>%
  mutate(agesplit = cut(test_age, breaks=c(3, 3.5, 4, 4.5, 5)))%>%
  mutate(split_2 = cut(test_age, breaks = c(3, 4, 5)))%>%
  filter(agesplit != "NA", num_given != "0 (8 oranges)", num_given != "0 (8 bananas)", num_given != "0 (8 strawberries)")


#this is because num_given is a factor - need to change to a number - need to do this for standard error
data$num_given <- as.character(data$num_given)
data$num_given <- as.numeric(data$num_given)

#creating dataframe for analyses
data_gq <- data
data_gq$test <- "Give-Quantifier"
```

Average given for each prompt by age group 
```{r}
agg.data <- aggregate(data$num_given, list(data$prompt, data$agesplit), FUN=mean)
agg.data.sd <- aggregate(data$num_given, list(data$prompt, data$agesplit), FUN=sd)

names(agg.data) <- c("prompt", "agesplit", "num_given")
agg.data$sd <- agg.data.sd$x

##establish limits
limits <- aes(ymax = num_given + sd, ymin=num_given - sd) 

#plot
quartz()
ggplot(data = agg.data, 
       aes(x=prompt, y=num_given, fill=agesplit)) +
  geom_bar(stat="identity", position = position_dodge())  + geom_errorbar(limits, position=dodge)+
  ylab("Mean num given") + 
  xlab("Quantifier prompt") +
  scale_fill_brewer(palette="Set1")


```

Histogram of responses, faceted by prompt, split by age
```{r}
#N.B. this is for 3s and 4s currently
hist_data <- data %>%
  group_by(split_2, prompt, num_given)%>%
  summarise(n = n()) %>%
  group_by(split_2, prompt) %>%
  mutate(n.total = sum(n), prop = n/n.total)

#plot
quartz()
ggplot(data = hist_data, aes(x = num_given, y = prop, fill = split_2)) + geom_bar(stat = "identity", position = position_dodge()) + xlab("Number Given") + ylab("Prop of kids giving number") + facet_wrap(~prompt) + scale_fill_brewer(palette="Set1")
```

Split by four age groups:

```{r}
hist_data <- data %>%
  group_by(agesplit, prompt, num_given)%>%
  summarise(n = n()) %>%
  group_by(agesplit, prompt) %>%
  mutate(n.total = sum(n), prop = n/n.total)

#plot
quartz()
ggplot(data = hist_data, aes(x = num_given, y = prop, fill = agesplit)) + 
  geom_bar(stat = "identity", position = position_dodge()) + 
  xlab("Number Given") +
  ylab("Prop of kids giving number") + 
  facet_wrap(agesplit~prompt) + 
  scale_fill_brewer(palette="Set1")

```


DCCS


Read in dataframe
```{r}
#wide-form
d1 <- read.csv("../data/DCCS_coding.csv")
#long form
d2=melt.data.frame(d1,c("sub_ID","test_age","condition", "order"),c("pre_1", "pre_2", "pre_3", "pre_4", "pre_5", "pre_6",  "post_1", "post_2", "post_3", "post_4", "post_5", "post_6"))

#filtering data, creating age breaks
data <- d2 %>%
  filter(sub_ID != "") %>%
  mutate(agesplit = cut(test_age, breaks=c(3, 3.5, 4, 4.5, 5)), split_2 = cut(test_age, breaks = c(3, 4, 5)))


#renaming things
names(data)[5] <- "trial_type"
names(data)[6] <- "DCCS_correct"

#df for further analyses
data_dccs <- data
data_dccs$test <- "DCCS"
  
```

Accuracy on DCCS task
```{r}
#aggregate correct by trial type and age
agg.data <- aggregate(data$DCCS_correct, list(data$trial_type, data$agesplit), FUN=sum)
agg.data.len <- aggregate(data$DCCS_correct, list(data$trial_type, data$agesplit), FUN=length)
agg.data$x <- agg.data$x 
agg.data.len$x <- agg.data.len$x 

names(agg.data) <- c("trial_type", "agesplit", "correct")
agg.data$total <- agg.data.len$x
agg.data$prop.corr <- agg.data$correct / agg.data$total

#standard error
agg.data$q <- 1 - agg.data$prop.corr
agg.data$err <- sqrt((agg.data$prop.corr * agg.data$q) / agg.data$total)

#variables established
dodge <- position_dodge(width=0.9) 
limits <- aes(ymax = prop.corr + err, ymin=prop.corr - err) 

#plot
quartz()
ggplot(data = agg.data, 
       aes(x=trial_type, y=prop.corr, fill=agesplit)) +
  geom_bar(stat="identity", position = position_dodge())  + geom_errorbar(limits, position=dodge)+
  ylab("Proportion correct") + 
  xlab("Trial Type") +
  scale_fill_brewer(palette="Set1") + facet_wrap(~agesplit)
```


Stats

Summary measures for each participant

First, SI
```{r}
#si df
data_si$SI_correct <- as.character(data_si$SI_correct)
data_si$SI_correct <- as.numeric(data_si$SI_correct)

#scalar implicature task
mss.acc <- data_si %>%
  group_by(sub_ID, type)%>%
  summarise(correct=mean(SI_correct))%>%
  spread(type, correct)
```

Now DCCS
```{r}
#this is a terrible and horrible thing that I had to do in order to get the data formatted correctly
tmp1 <- unlist(data_dccs$trial_type)%>%
  str_replace("pre_1", "pre")%>%
  str_replace("pre_2", "pre")%>%
  str_replace("pre_3", "pre")%>%
  str_replace("pre_4", "pre")%>%
  str_replace("pre_5", "pre")%>%
  str_replace("pre_6", "pre")%>%
  str_replace("post_1", "post")%>%
  str_replace("post_2", "post")%>%
  str_replace("post_3", "post")%>%
  str_replace("post_4", "post")%>%
  str_replace("post_5", "post")%>%
  str_replace("post_6", "post")

#seriously, this is so terrible
tmp <- as.data.frame(tmp1) %>%
  select(switch_type = tmp1)
tmp2 <- bind_cols(data_dccs, tmp)
data_dccs <- tmp2

#dccs task summary measures by participant
mss.acc2 <- data_dccs %>%
  group_by(sub_ID, switch_type)%>%
  summarise(correct=mean(DCCS_correct))%>%
  spread(switch_type, correct)

```

Now GQ
```{r}
#gq task - note that some of these are NAs because the kids gave 0 of the named fruit, but 8 of another fruit
mss.acc3 <- data_gq %>%
  group_by(sub_ID, prompt)%>%
  summarise(mean_num = mean(num_given), 
            test_age = test_age[1]) %>%
  spread(prompt, mean_num)
```

Create a wide-form df on which to run analyses - note that these are the mean performances across all trials per participant
```{r}
#this is joining the summary measures we created above, and renaming the variables so that we keep everything straight
tmp <- right_join(mss.acc, mss.acc2, by = "sub_ID")
d_all <- right_join(tmp, mss.acc3, by = "sub_ID") %>%
  rename(SI_none = control_none, 
         SI_all = control_all, 
         SI_implicature = implicature, 
         DCCS_post = post, DCCS_pre = pre, 
         GQ_all = all, 
         GQ_most = most, 
         GQ_some = some, 
         GQ_none = none)
```


Simple Correlations


Huge correlation matrix of all variables
```{r}
source("ggcorplot.R")

d_all$GQ_none[is.na(d_all$GQ_none)] <- 0 # backfill when they gave the wrong object (but none of the target)
cor.data <- d_all %>%
  select(-sub_ID, -GQ_all, -DCCS_pre) %>%
  filter(complete.cases(.)) %>%
  data.frame

quartz()
ggcorplot(data=cor.data)
```



Partial correlations - control for age
First, Scalar Implicature with DCCS and SI
```{r}
library(ppcor)
#partial correlation - implicature and dccs
pcor.test(d_all$SI_implicature, d_all$DCCS_post, d_all$test_age)

pcor.test(d_all$SI_implicature, d_all$SI_none, d_all$test_age)
#Significant correlation between performance on implicature and none trials in SI task after controlling for age

pcor.test(d_all$SI_none, d_all$DCCS_post, d_all$test_age)
```

Then GQ with DCCS and GQ
```{r}
pcor.test(d_all$GQ_none, d_all$DCCS_post, d_all$test_age)

pcor.test(d_all$GQ_some, d_all$DCCS_post, d_all$test_age)

pcor.test(d_all$GQ_none, d_all$GQ_some, d_all$test_age)
#highly significant correlation between performance on GQ none and some trials, controlling for age
```

Finally GQ with SI
```{r}
pcor.test(d_all$SI_implicature, d_all$GQ_some, d_all$test_age)

pcor.test(d_all$SI_none, d_all$GQ_some, d_all$test_age)
#almost signficant negative correlation between SI_none performance and GQ_some, controlling for age. This means that kids who do worse on the SI_none tasks are more likely to give more items for GQ_some (aka give 8 items for some)

pcor.test(d_all$SI_implicature, d_all$GQ_none, d_all$test_age)

pcor.test(d_all$SI_none, d_all$GQ_none, d_all$test_age)
#very significant negative correlation between performance on SI_none and GQ_none, meaning that kids who do worse on SI_none are more likely to give all 8 objects for none
```

Summary of partial correlations: 
After controlling for age, we find significant correlations between:
SI-none and SI-implicature - this means that kids who get SI implicature trials correct are also more likely to get SI none trials correct
GQ-some and GQ-none trials - similar to above
SI-none and GQ-none - negative correlation, meaning that kids who do worse on SI-none trials are more likely to fail (give more objects) for GQ-none trials

Almost signficant correlation between:
SI-none and GQ-some trials - similar to above

Linear Models

Try predicting none on the basis of control.

```{r}
summary(glm(SI_none ~  DCCS_post, data=d_all, 
            family = "binomial"))
summary(glm(SI_none ~  DCCS_post + test_age, data=d_all, 
            family = "binomial"))
summary(glm(GQ_none == 0 ~  DCCS_post, data=d_all, 
            family = "binomial"))
summary(glm(GQ_none == 0 ~  DCCS_post + test_age, data=d_all, 
            family = "binomial"))
```




Also try a super-exploratory analysis where we put together the none trials

```{r}
d_all <- d_all %>%
  mutate(none_composite = ((as.numeric(GQ_none==0) + SI_none)/2) > .5)

summary(glm(none_composite ~ test_age + DCCS_post, data=d_all, 
            family = "binomial"))



summary(glm(none_composite ~  DCCS_post, data=d_all, 
            family = "binomial"))
summary(glm(none_composite ~ test_age + DCCS_post, data=d_all, 
            family = "binomial"))


```


